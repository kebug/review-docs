# golang中的defer是什么？



在Go语言中，`defer`语句用于安排随后的函数调用（deferred function）在包含它的函数返回时执行。这通常用于执行一些清理任务，例如文件关闭、解锁资源等。`defer`的行为类似于其他语言中的finally块。

### `defer` 的基本用法
使用`defer`关键字后跟一个函数调用，这个调用不会立即执行，而是在包含它的函数结束时执行。无论包含它的函数是通过返回结束，还是由于一个未处理的panic导致的异常结束，都会执行`defer`。

#### 示例：

```go
func main() {
    f := openFile("file.txt")
    defer f.Close()

    // 在这里处理文件
}
```
在这个例子中，不管`main`函数正常结束还是因错误提前退出，`f.Close()`都会在`main`函数退出之前执行，确保了文件资源被适当地关闭。

### 执行顺序
如果一个函数中有多个`defer`语句，它们的执行顺序是后进先出（LIFO）。最后声明的`defer`语句将最先被执行。

#### 示例：

```go
func main() {
    defer fmt.Println("first")
    defer fmt.Println("second")
    defer fmt.Println("third")

    fmt.Println("function body")
}
```
这段代码会输出：
```
function body
third
second
first
```
### 为什么使用`defer`
`defer`的使用有几个常见的理由：
1. **确保清理操作执行**：无论函数因何种路径退出，`defer`都保证了清理代码被执行，这对于错误处理和资源管理非常有用。
2. **简化复杂函数**：在处理错误时，`defer`可以减少需要多次调用清理代码的情况，简化函数逻辑。
3. **错误处理和资源释放**：在需要配对调用（如`open/close`、`lock/unlock`等）的地方，`defer`确保资源正确释放，避免了资源泄露。

### 注意事项
虽然`defer`非常有用，但使用时也需要注意一些问题：
- **性能影响**：`defer`语句会稍微影响性能，因为需要维护一个栈来记录deferred函数调用。在性能敏感的代码中，应该注意这一点。
- **延迟执行**：由于`deferred`函数是在包含函数结束时才执行的，因此需要确保这种延迟执行是可接受的。
- **参数评估**：`defer`语句中的函数其参数会立即求值，而不是在函数实际执行时求值。

通过适当使用`defer`，可以有效地管理资源和错误处理，使代码更加健壮和清晰。