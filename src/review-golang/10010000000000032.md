# go语言垃圾回收的工作原理



Go语言的垃圾回收（GC）机制是一个自动内存管理系统，主要用于回收不再被程序使用的内存空间。Go采用的是“三色标记-清除”算法（Tri-color marking and sweep algorithm）进行垃圾回收。这个算法的工作流程可以分为几个阶段：

### 1. 标记阶段（Mark phase）
- **三色标记**: 在这个阶段，GC使用黑色、灰色和白色三种颜色来标记对象。
  - **黑色**: 表示对象已经被扫描，并且该对象内部的引用也已经被扫描。
  - **灰色**: 表示对象已经被扫描，但对象内部的引用还没有被完全扫描。
  - **白色**: 表示对象还没有被扫描。
- 这个阶段开始时，所有的对象都被标记为白色。根对象（比如全局变量、活跃协程的栈上的变量）首先被标记为灰色，然后逐步扫描这些灰色对象。扫描过程中，从灰色对象引用的其他对象会被转变为灰色，原对象转为黑色。

### 2. 清扫阶段（Sweep phase）
- 在所有对象被正确标记之后，GC进入清扫阶段。在这个阶段，所有标记为白色的对象（即未被引用的对象）会被回收。
- 清扫过程是懒惰进行的，意味着并非立即一次性清扫所有垃圾对象，而是根据程序的内存分配活动逐渐进行。

### 3. 并发和暂停
- **并发GC**: Go的GC设计为并发执行，意味着垃圾回收器的大部分工作是与程序的主执行流并行进行的。这减少了GC引起的程序暂停时间，提高了程序的响应性和性能。
- **STW（Stop-The-World）暂停**: 虽然Go的GC尽量减少暂停时间，但在标记开始和清扫结束时仍然需要短暂的STW暂停，以确保所有的内存都正确标记和清扫。

### 4. 优化和调整
- Go语言还提供了一些调优GC的手段，例如可以通过设置环境变量`GOGC`（默认为100）来调整GC的触发频率。`GOGC`的值越大，允许的堆增长越多，GC触发得越不频繁，反之亦然。

Go语言的GC机制在不断进化中，每个新版本都可能带来更优的性能和更低的延迟。